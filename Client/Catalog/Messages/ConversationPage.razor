@page "/conversation"
@attribute [Authorize]
@layout ConversationLayout
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Catalog.Client
@using Humanizer
@implements IAsyncDisposable
@inject IMessagesClient MessagesClient
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IAccessTokenProvider AccessTokenProvider
@inject Catalog.Shared.Authorization.ICurrentUserService CurrentUserService
@inject IJSRuntime JSRuntime

<PageTitle>Chat - Catalog</PageTitle>

<MudGrid>
    <MudItem xs="12" sm="12" md="8">

            <MudChatSection>
                <Header>
                    <MudText Typo="Typo.h6" Class="mt-6 mb-4" Align="Align.Center">Conversation</MudText>
                </Header>

                <ChildContent>
                    @foreach (var message in messages) 
                    {
                                int messageIndex = messages.IndexOf(message);
                                Message? previousMessage = null;
                                Message? nextMessage = null;
                                if(messageIndex > 0) 
                                {
                                    previousMessage = messages[messageIndex - 1];
                                }
                                if(messageIndex < messages.Count - 1) 
                                {
                                    nextMessage = messages[messageIndex + 1];
                                }

                                bool isFirst = previousMessage == null || !FromSameSender(message, previousMessage);
                                bool isLast = nextMessage == null || !IsSameTime(message, nextMessage) || !FromSameSender(message, nextMessage);
                                bool isSameSenderAsPrevious = previousMessage == null || FromSameSender(message, previousMessage);
                                
                                bool sameMinutesAsLast = previousMessage == null || IsSameTime(message, previousMessage);

                            <MudMessage @key="@message.Id" Position="@(IsFromCurrentUser(message) ? MessagePosition.Right : MessagePosition.Left)">
                                
                                    <Footer>
                                        @*
                                        @if (isLast)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: gray;">@message.DateSent.GetValueOrDefault().ToString("HH:mm")</MudText>
                                        }
                                        *@
                                    </Footer>

                                <SideContent>
                                    @if (!IsFromCurrentUser(message))
                                    {
                                        if(!isSameSenderAsPrevious || isFirst || sameMinutesAsLast) 
                                        {
                                            <div class="message-avatar">
                                                <MudAvatar Size="Size.Small">@GetInitials(message.Sender)</MudAvatar>
                                            </div>
                                        }
                                    }
                                </SideContent>

                                <Content>
                                    @message.Content
                                    <div class="row d-flex flex-row flex-grow-1 gap-2">
                                        @if(IsFromCurrentUser(message)) 
                                        {
                                            <MudIcon Icon="@Icons.Filled.CheckCircle" Size="Size.Small" />
                                        }
                                        <small class="time">@message.DateSent.GetValueOrDefault().ToString("HH:mm")</small>
                                    </div>
                                </Content>
    @*
                                <Overlay>
                                    ❤️
                                </Overlay>
    *@
                                <Actions>
                                        <MudMenu AnchorOrigin="Origin.BottomLeft">
                                            <ActivatorContent>
                                                <MudIconButton Style="margin-top: -5px; padding: 10px;" Icon="@Icons.Filled.MoreVert"
                                                    Variant="Variant.Text" Color="Color.Secondary" />
                                            </ActivatorContent>
                                            <ChildContent>
                                                <MudMenuItem>Delete</MudMenuItem>
                                                <MudMenuItem>Report</MudMenuItem>
                                            </ChildContent>
                                        </MudMenu>
                                </Actions>
                            </MudMessage>
                        }
                </ChildContent>
            </MudChatSection>

            <div style="height: 90px"></div>

        @* <div>
            <MudText Typo="Typo.subtitle2" Class="mt-6 mb-4" Align="Align.Center">Conversation ended 11:37</MudText>
        </div> *@
    </MudItem>

    <MudItem xs="12" sm="12" md="4">

    </MudItem>
</MudGrid>

<div class="bottom d-flex flex-grow-1 gap-4">
    <div class="flex-auto d-flex" style="width: 100%">
        <MudTextField @bind-Value="text" Variant="Variant.Filled" Class="rounded-lg" Lines="1"></MudTextField>
    </div>
    <div class="flex-auto d-flex" style="width: 54px">
        <MudIconButton Variant="Variant.Filled" Color="Color.Primary" Icon="@Icons.Filled.Send" Class="mt-2" Style="border-radius: 50%; padding: 15px;" OnClick="Post" />
    </div>
</div>

@code {
    HubConnection hubConnection;

    string userId;

    List<Message> messages = new List<Message>();

    string GetInitials(string name) 
    {
        var nameParts = name.Split(" ");
        return $"{nameParts[0][0]}{nameParts[1][0]}";
    }

    bool IsFromCurrentUser(Message message) 
    {
        return message.SenderId == userId;
    }

    bool FromSameSender(Message m1, Message m2) 
    {
        return m1.SenderId == m2.SenderId;
    }

    bool IsSameTime(Message m1, Message m2) 
    {
        return (m1.DateSent.GetValueOrDefault().Hour == m2.DateSent.GetValueOrDefault().Hour
                && m1.DateSent.GetValueOrDefault().Minute == m2.DateSent.GetValueOrDefault().Minute);
    }

    protected override async Task OnInitializedAsync()
    {
        userId = await CurrentUserService.GetUserId();
        try
        {
            hubConnection = new HubConnectionBuilder().WithUrl($"{NavigationManager.BaseUri}api/hubs/messages", options =>
            {
                options.AccessTokenProvider = async () =>
                {
                    var results = await AccessTokenProvider.RequestAccessToken(new AccessTokenRequestOptions()
                    {Scopes = new[]{"myapi"}});
                    if (results.TryGetToken(out var accessToken))
                    {
                        return accessToken.Value;
                    }

                    return null !;
                };
            }).WithAutomaticReconnect().Build();

            hubConnection.On<UserDto2>("UserJoined", OnUserJoined);
            hubConnection.On<MessageDto>("MessageReceived", OnMessageReceived);
            hubConnection.On<UserDto2>("UserLeft", OnUserLeft);

            hubConnection.Closed += (error) =>
            {
                if (error is not null)
                {
                    Snackbar.Add($"{error.Message}", Severity.Error);
                }

                Snackbar.Add("Connection closed");
                return Task.CompletedTask;
            };
            hubConnection.Reconnected += (error) =>
            {
                Snackbar.Add("Reconnected");
                return Task.CompletedTask;
            };
            hubConnection.Reconnecting += (error) =>
            {
                Snackbar.Add("Reconnecting");
                return Task.CompletedTask;
            };
            await hubConnection.StartAsync();
            Snackbar.Add("Connected");
        }
        catch (Exception exc)
        {
            Snackbar.Add(exc.Message.ToString(), Severity.Error);
        }

        await LoadItems(30);

        await JSRuntime.InvokeVoidAsync("helpers.attachScrollEventHandler", DotNetObjectReference.Create(this));
        
        await JSRuntime.InvokeVoidAsync("helpers.scrollToBottom");
    }

    void OnUserJoined(UserDto2 dto)
    {
        Snackbar.Add($"{dto.User} has joined the conversation.");

        StateHasChanged();
    }

    void OnUserLeft(UserDto2 dto)
    {
        Snackbar.Add($"{dto.User} has left the conversation.");

        StateHasChanged();
    }

    async Task OnMessageReceived(MessageDto dto)
    {
        messages.Add(new Message() {
            Id = dto.Id!,
            Sender = dto.SentBy,
            SenderId = dto.SentById,
            Content = dto.Content!,
            DateSent = dto.DateSent
        });

        this.skip++;

        StateHasChanged();
        
        await JSRuntime.InvokeVoidAsync("helpers.scrollToBottom");
    }

    public record Point(double X, double Y);

    double lastY = 9999;
    double threshold = 900;

    [JSInvokable("OnScroll")]
    public async Task OnScroll(Point args)
    {
        if(Math.Round(args.Y) % 10 != 0)
        {
            return;
        }

        if(args.Y < lastY) 
        {
            Console.WriteLine(args);

            if(args.Y <= threshold) 
            {
                await LoadItemsIncr(30);
            }
        }
        
        lastY = args.Y;
    }

    int skip = 0;
    int total = 0;

    async Task LoadItems(int take = 10)
    {
        messages.Clear();

        this.skip = 0;
        await LoadItemsCore(take);
    }

    async Task LoadItemsCore(int take = 10)
    {
        var results = await MessagesClient.GetMessagesAsync(this.skip, take, null!, null);
        total = results.TotalCount;
        this.skip += results.Items.Count;

        foreach(var dto in results.Items)
        {
            var message = new Message() {
                Id = dto.Id,
                Sender = dto.CreatedBy.FirstName + " " + dto.CreatedBy.LastName,
                SenderId = dto.CreatedBy.Id,
                Content = dto.Text!,
                DateSent = dto.Created.DateTime
            };

            messages.Insert(0, message);
        }

        StateHasChanged();
    }

    bool loading;

    async Task LoadItemsIncr(int take = 10)
    {
        if(loading)
        {
            return;
        }

        try 
        {
            loading = true;

            if(messages.Count == total) 
            {
                return;
            }

            Console.WriteLine(total);
            Console.WriteLine(skip);

            await LoadItemsCore(take);
        }
        finally
        {
            loading = false;
        }
    } 

    class MessageDto
    {
        public string? Id { get; set; }

        public string SentBy { get; set; } = null!;

        public string SentById { get; set; } = null!;

        public string? Content { get; set; }

        public DateTime DateSent { get; set; }
    }

    public class UserDto2
    {
        public string User { get; set; } = null!;
        public string? UserId { get; set; }
    }

    public async ValueTask DisposeAsync()
    {
        await hubConnection.DisposeAsync();
    }

    async Task Post()
    {
        if(string.IsNullOrEmpty(text))
        {
            return;
        }

        await hubConnection.SendAsync("SendMessage", text);

        text = string.Empty;
    }

    string text;

    public class Section
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();

        public string? Header { get; set; }

        public List<Message> Messages { get; set; } = new List<Message>();
    }


    public class Message
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();

        public string Sender { get; set; } = null!;

        public string SenderId { get; set; } = null!;

        public string Content { get; set; } = null!;

        public DateTime? DateSent { get; set; }
    }
}