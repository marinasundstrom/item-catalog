@page "/notifications"
@using Catalog.Client
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject INotificationsClient NotificationsClient

<PageTitle>Notifications</PageTitle>

<MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">Notifications</MudText>

<MudTable T="NotificationDto" Dense="true" @ref="table" SortLabel="Sort By" ServerData="@(new Func<TableState, Task<TableData<NotificationDto>>>(ServerReload))" OnRowClick="RowClickEvent" Hover="true" Breakpoint="Breakpoint.Sm" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh></MudTh>
        <MudTh><MudTableSortLabel T="NotificationDto" SortLabel="Title">Title</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel T="NotificationDto" SortLabel="Text">Text</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel T="NotificationDto" SortLabel="Published">Published</MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            @if (!context.IsRead)
            {
                <MudIcon Icon="@Icons.Material.Filled.Circle" />
            }
        </MudTd>
        <MudTd DataLabel="Title">@context.Title</MudTd>
        <MudTd DataLabel="Text">@context.Text</MudTd>
        <MudTd DataLabel="Published">@(context.Published.Date == DateTime.Now.Date ? context.Published.ToString("HH:mm") : context.Published.ToString("yyyy-MM-dd HH:mm"))</MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText>No matching records found</MudText>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>Loading...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    MudTable<NotificationDto> table;

    private async Task<TableData<NotificationDto>> ServerReload(TableState state)
    {
        var results = await NotificationsClient.GetNotificationsAsync(false, state.Page + 1, state.PageSize, state.SortLabel,
            state.SortDirection == MudBlazor.SortDirection.Ascending ? Catalog.Client.SortDirection.Asc : Catalog.Client.SortDirection.Desc);

        return new TableData<NotificationDto>() { TotalItems = results.TotalCount, Items = results.Items };
    }

    private void RowClickEvent(TableRowClickEventArgs<NotificationDto> args)
    {
        //NavigationManager.NavigateTo($"/notifications/{args.Item.Id}");
    }
}

